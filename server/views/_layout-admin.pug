doctype html

block vars

- var page = pageClass || ''
- var title = pageTitle || ''

html(lang=getLocale())
  head
    include _head-material

  body.mdl-color--grey-100.mdl-color-text--grey-700(class=page)
    .mdl-layout.mdl-js-layout.mdl-layout--fixed-header
      header.mdl-layout__header
        .mdl-layout__header-row
          //- Title
          span.mdl-layout-title= title
          //- Add spacer, to align navigation to the right
          .mdl-layout-spacer
          //- Navigation. We hide it in small screens
          nav.mdl-navigation.mdl-layout--large-screen-only
            a.mdl-navigation__link(href="/") mailings
            a.mdl-navigation__link(href="/new-creation") templates
            a.mdl-navigation__link(href="/admin")
              i#nav-companies.material-icons group
              .mdl-tooltip(data-mdl-for="nav-companies") companies
            a.mdl-navigation__link(href="/users")
              i#nav-users.material-icons person
              .mdl-tooltip(data-mdl-for="nav-users") users
            a.mdl-navigation__link(href="/wireframes")
              i#nav-templates.material-icons web
              .mdl-tooltip(data-mdl-for="nav-templates") templates list
            a.mdl-navigation__link(href="/logout")
              i.material-icons power_settings_new

      .mdl-layout__drawer
        span.mdl-layout-title= title
        nav.mdl-navigation
          a.mdl-navigation__link(href="/") mailings
          a.mdl-navigation__link(href="/new-creation") templates
          a.mdl-navigation__link(href="/admin") companies
          a.mdl-navigation__link(href="/users") users
          a.mdl-navigation__link(href="/wireframes") wireframes
          a.mdl-navigation__link(href="/logout") logout


      main.mdl-layout__content(class=page === 'full-width-layout' ? 'mdl-grid mdl-grid--no-spacing' : '' )
        block content
        dialog.js-dialog-confirm.mdl-dialog
          h4.mdl-dialog__title.js-dialog-title
          .mdl-dialog__content: p.js-dialog-description
          .mdl-dialog__actions
            a(href="#").js-dialog-confirm.mdl-button.mdl-button--accent.mdl-js-button ok
            button(type="button").js-dialog-cancel.js-close-rename-dialog.mdl-button cancel
        script.
          (function(){
            //- dialog handling
            //- window.confirm is raising warnings in chromeâ€¦
            var dialog  = document.querySelector('.js-dialog-confirm')
            if (!dialog.showModal) return
            var title       = dialog.querySelector('.js-dialog-title')
            var description = dialog.querySelector('.js-dialog-description')
            var confirmLink = dialog.querySelector('.js-dialog-confirm')
            dialog.querySelector('.js-dialog-cancel').addEventListener('click', function () {
              dialog.close()
            })
            dialog.addEventListener('cancel', function () { resetDialog() })
            dialog.addEventListener('close', function () {  resetDialog() })
            function resetDialog() {
              title.textContent       = ''
              description.textContent = ''
              confirmLink.setAttribute('href', '#')
              //- clone to remove all event listeners
              confirmLinkClone  = confirmLink.cloneNode(true)
              confirmLink.parentNode.replaceChild(confirmLinkClone, confirmLink)
              confirmLink       = confirmLinkClone
            }
            function openDialog( datas ) {
              title.textContent       = datas.title
              description.textContent = datas.description
              dialog.showModal()
            }
            //- delete wireframes
            var deleteButtons = document.querySelectorAll('.js-delete-wireframe')
            addListeners(deleteButtons, 'click', askWireframeDeletion)
            function askWireframeDeletion(e) {
              e.preventDefault()
              var link                = e.currentTarget
              var wireframeName       = link.dataset.name
              confirmLink.setAttribute( 'href', link.getAttribute('href') )
              openDialog( {
                title:        'Delete template',
                description:  'are you sure you want to delete ' + wireframeName + '?',
              } )
            }
            //- reset user
            var resetUsers  = document.querySelectorAll('form.js-reset-user')
            addListeners(resetUsers, 'submit', askUserReset)
            function askUserReset(e) {
              e.preventDefault()
              var form                = e.currentTarget
              var userName            = form.dataset.name
              confirmLink.addEventListener('click', function (e) {
                e.preventDefault()
                form.submit()
              })
              openDialog( {
                title:        'Reset',
                description:  'are you sure you want to reset ' + userName + ' password?',
              } )
            }
            //- activate user
            var activateUsers  = document.querySelectorAll('.js-user-activate')
            addListeners(activateUsers, 'click', askUserActivation)
            function askUserActivation(e) {
              e.preventDefault()
              var link                = e.currentTarget  
              var userName            = link.dataset.name
              confirmLink.setAttribute( 'href', link.getAttribute('href') )
              openDialog( {
                title:        'Activate',
                description:  'are you sure you want to activate ' + userName + '?',
              } )
            }
            //- deactivate user
            var deactivateUsers  = document.querySelectorAll('.js-user-deactivate')
            addListeners(deactivateUsers, 'click', askUserDeactivation)
            function askUserDeactivation(e) {
              e.preventDefault()
              var link                = e.currentTarget
              var userName            = link.dataset.name  
              confirmLink.setAttribute( 'href', link.getAttribute('href') )
              openDialog( {
                title:        'Deactivate',
                description:  'are you sure you want to deactivate ' + userName + '?',
              } )
            }
            //- utils
            function addListeners( elems, eventName, callback ) {
              if (!elems.length) return
              for (var i = 0; i < elems.length; i++ ) {
                var elem = elems[ i ]
                elem.addEventListener( eventName, callback)
              }
            }

            function getParent( elem, selector ) {
              var parent = false
              for ( ; elem && elem !== document; elem = elem.parentNode ) {
                if ( elem.matches( selector ) ) {
                  parent = elem
                  break
                }
              }
              return parent
            }
          })()

        if _config.debug
          footer(style="background: #eee")
            pre= JSON.stringify(data, null, '  ')
            pre= _debug
