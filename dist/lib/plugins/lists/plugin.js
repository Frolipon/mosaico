tinymce.PluginManager.add("lists",function(e){function t(t){return e.$.contains(e.getBody(),t)}function n(e){return e&&"BR"==e.nodeName}function r(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)&&t(e)}function o(e){return e&&/^(LI|DT|DD)$/.test(e.nodeName)}function i(e){return e.parentNode.firstChild==e}function a(e){return e.parentNode.lastChild==e}function d(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function s(t){return t===e.getBody()}function f(e){return e&&3===e.nodeType}function l(e,t){var n=tinymce.dom.RangeUtils.getNode(e,t);if(o(e)&&f(n)){return{container:n,offset:t>=e.childNodes.length?n.data.length:0}}return{container:e,offset:t}}function c(e){var t=e.cloneRange(),n=l(e.startContainer,e.startOffset);t.setStart(n.container,n.offset);var r=l(e.endContainer,e.endOffset);return t.setEnd(r.container,r.offset),t}var u=this;e.on("init",function(){function f(e,t){var n=x.isEmpty(e);return!(t&&x.select("span[data-mce-type=bookmark]").length>0)&&n}function l(e){function t(t){var r,o,i;o=e[t?"startContainer":"endContainer"],i=e[t?"startOffset":"endOffset"],1==o.nodeType&&(r=x.create("span",{"data-mce-type":"bookmark"}),o.hasChildNodes()?(i=Math.min(i,o.childNodes.length-1),t?o.insertBefore(r,o.childNodes[i]):x.insertAfter(r,o.childNodes[i])):o.appendChild(r),o=r,i=0),n[t?"startContainer":"endContainer"]=o,n[t?"startOffset":"endOffset"]=i}var n={};return t(!0),e.collapsed||t(),n}function m(e){function t(t){var n,r,o;n=o=e[t?"startContainer":"endContainer"],r=e[t?"startOffset":"endOffset"],n&&(1==n.nodeType&&(r=function(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}(n),n=n.parentNode,x.remove(o)),e[t?"startContainer":"endContainer"]=n,e[t?"startOffset":"endOffset"]=r)}t(!0),t();var n=x.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),P.setRng(c(n))}function p(t,n){var r,o,i,a=x.createFragment(),d=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(o=x.create(n),o.tagName===e.settings.forced_root_block&&x.setAttribs(o,e.settings.forced_root_block_attrs),a.appendChild(o)),t)for(;r=t.firstChild;){var s=r.nodeName;i||"SPAN"==s&&"bookmark"==r.getAttribute("data-mce-type")||(i=!0),d[s]?(a.appendChild(r),o=null):n?(o||(o=x.create(n),a.appendChild(o)),o.appendChild(r)):a.appendChild(r)}return e.settings.forced_root_block?i||tinymce.Env.ie&&!(tinymce.Env.ie>10)||o.appendChild(x.create("br",{"data-mce-bogus":"1"})):a.appendChild(x.create("br")),a}function g(){return tinymce.grep(P.getSelectedBlocks(),function(e){return o(e)})}function h(e,t,n){var r,o,i,a;for(i=x.select('span[data-mce-type="bookmark"]',e),n=n||p(t),r=x.createRng(),r.setStartAfter(t),r.setEndAfter(e),o=r.extractContents(),a=o.firstChild;a;a=a.firstChild)if("LI"==a.nodeName&&x.isEmpty(a)){x.remove(a);break}x.isEmpty(o)||x.insertAfter(o,e),x.insertAfter(n,e),f(t.parentNode)&&function(e){tinymce.each(i,function(n){e.parentNode.insertBefore(n,t.parentNode)}),x.remove(e)}(t.parentNode),x.remove(t),f(e)&&x.remove(e)}function v(e){var t,n;if((t=e.nextSibling)&&r(t)&&t.nodeName==e.nodeName&&U(e,t)){for(;n=t.firstChild;)e.appendChild(n);x.remove(t)}if((t=e.previousSibling)&&r(t)&&t.nodeName==e.nodeName&&U(e,t)){for(;n=t.firstChild;)e.insertBefore(n,e.firstChild);x.remove(t)}}function C(e){tinymce.each(tinymce.grep(x.select("ol,ul",e)),y)}function y(e){var t,n=e.parentNode;"LI"==n.nodeName&&n.firstChild==e&&(t=n.previousSibling,t&&"LI"==t.nodeName?(t.appendChild(e),f(n)&&x.remove(n)):x.setStyle(n,"listStyleType","none")),r(n)&&(t=n.previousSibling)&&"LI"==t.nodeName&&t.appendChild(e)}function N(e){function t(e){f(e)&&x.remove(e)}var n,o=e.parentNode,d=o.parentNode;return!!s(o)||("DD"==e.nodeName?(x.rename(e,"DT"),!0):i(e)&&a(e)?("LI"==d.nodeName?(x.insertAfter(e,d),t(d),x.remove(o)):r(d)?x.remove(o,!0):(d.insertBefore(p(e),o),x.remove(o)),!0):i(e)?("LI"==d.nodeName?(x.insertAfter(e,d),e.appendChild(o),t(d)):r(d)?d.insertBefore(e,o):(d.insertBefore(p(e),o),x.remove(e)),!0):a(e)?("LI"==d.nodeName?x.insertAfter(e,d):r(d)?x.insertAfter(e,o):(x.insertAfter(p(e),o),x.remove(e)),!0):("LI"==d.nodeName?(o=d,n=p(e,"LI")):n=r(d)?p(e,"LI"):p(e),h(o,e,n),C(o.parentNode),!0))}function L(e){function t(t,n){var o;if(r(t)){for(;o=e.lastChild.firstChild;)n.appendChild(o);x.remove(t)}}var n,o,i;return"DT"==e.nodeName?(x.rename(e,"DD"),!0):(n=e.previousSibling)&&r(n)?(n.appendChild(e),!0):n&&"LI"==n.nodeName&&r(n.lastChild)?(n.lastChild.appendChild(e),t(e.lastChild,n.lastChild),!0):(n=e.nextSibling)&&r(n)?(n.insertBefore(e,n.firstChild),!0):!(!(n=e.previousSibling)||"LI"!=n.nodeName)&&(o=x.create(e.parentNode.nodeName),i=x.getStyle(e.parentNode,"listStyleType"),i&&x.setStyle(o,"listStyleType",i),n.appendChild(o),o.appendChild(e),t(e.lastChild,o),!0)}function S(){var t=g();if(t.length){for(var n=l(P.getRng(!0)),r=0;r<t.length&&(L(t[r])||0!==r);r++);return m(n),e.nodeChanged(),!0}}function b(){var t=g();if(t.length){var n,r,o=l(P.getRng(!0)),i=e.getBody();for(n=t.length;n--;)for(var a=t[n].parentNode;a&&a!=i;){for(r=t.length;r--;)if(t[r]===a){t.splice(n,1);break}a=a.parentNode}for(n=0;n<t.length&&(N(t[n])||0!==n);n++);return m(o),e.nodeChanged(),!0}}function k(t,o){var i,a=P.getRng(!0),s="LI";"false"!==x.getContentEditable(P.getNode())&&(t=t.toUpperCase(),"DL"==t&&(s="DT"),i=l(a),tinymce.each(function(){function t(e){var t,n;for(t=a[e?"startContainer":"endContainer"],n=a[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=i;){if(d(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var r,o=[],i=e.getBody(),s=t(!0),f=t(),l=[],c=s;c&&(l.push(c),c!=f);c=c.nextSibling);return tinymce.each(l,function(e){if(d(e))return o.push(e),void(r=null);if(x.isBlock(e)||n(e))return n(e)&&x.remove(e),void(r=null);var t=e.nextSibling;if(tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(d(t)||!t&&e.parentNode==i))return void(r=null);r||(r=x.create("p"),e.parentNode.insertBefore(r,e),o.push(r)),r.appendChild(e)}),o}(),function(e){var n,i;i=e.previousSibling,i&&r(i)&&i.nodeName==t&&function(e){var t=x.getStyle(e,"list-style-type"),n=o?o["list-style-type"]:"";return n=null===n?"":n,t===n}(i)?(n=i,e=x.rename(e,s),i.appendChild(e)):(n=x.create(t),e.parentNode.insertBefore(n,e),n.appendChild(e),e=x.rename(e,s)),_(n,o),v(n)}),m(i))}function D(){var t=l(P.getRng(!0)),n=e.getBody();tinymce.each(g(),function(e){var t,o;if(!s(e.parentNode)){if(f(e))return void N(e);for(t=e;t&&t!=n;t=t.parentNode)r(t)&&(o=t);h(o,e),C(o.parentNode)}}),m(t)}function B(e,t){var n=x.getParent(P.getStart(),"OL,UL,DL");if(!s(n))if(n)if(n.nodeName==e)D(e);else{var r=l(P.getRng(!0));_(n,t),v(x.rename(n,e)),m(r)}else k(e,t)}function I(t){return function(){var n=x.getParent(e.selection.getStart(),"UL,OL,DL");return n&&n.nodeName==t}}function O(e){return!!n(e)&&!(!x.isBlock(e.nextSibling)||n(e.previousSibling))}function T(t,n){var r,o,i=t.startContainer,a=t.startOffset;if(3==i.nodeType&&(n?a<i.data.length:a>0))return i;for(r=e.schema.getNonEmptyElements(),1==i.nodeType&&(i=tinymce.dom.RangeUtils.getNode(i,a)),o=new tinymce.dom.TreeWalker(i,e.getBody()),n&&O(i)&&o.next();i=o[n?"next":"prev2"]();){if("LI"==i.nodeName&&!i.hasChildNodes())return i;if(r[i.nodeName])return i;if(3==i.nodeType&&i.data.length>0)return i}}function E(e,o){var i,a,d=e.parentNode;if(t(e)&&t(o)){if(r(o.lastChild)&&(a=o.lastChild),d==o.lastChild&&n(d.previousSibling)&&x.remove(d.previousSibling),i=o.lastChild,i&&n(i)&&e.hasChildNodes()&&x.remove(i),f(o,!0)&&x.$(o).empty(),!f(e,!0))for(;i=e.firstChild;)o.appendChild(i);a&&o.appendChild(a),x.remove(e),f(d)&&!s(d)&&x.remove(d)}}function A(e){var t,n,r,o=x.getParent(P.getStart(),"LI");if(o){if(t=o.parentNode,s(t)&&x.isEmpty(t))return!0;if(n=c(P.getRng(!0)),(r=x.getParent(T(n,e),"LI"))&&r!=o){var i=l(n);return e?E(r,o):E(o,r),m(i),!0}if(!r&&!e&&D(t.nodeName))return!0}}function R(){return!!(e.dom.getParent(e.selection.getStart(),"LI,DT,DD")||g().length>0)&&(e.undoManager.transact(function(){e.execCommand("Delete"),C(e.getBody())}),!0)}var x=e.dom,P=e.selection,U=function(t,n){return e.dom.getStyle(t,"list-style-type",!0)===e.dom.getStyle(n,"list-style-type",!0)},_=function(e,t){x.setStyle(e,"list-style-type",t?t["list-style-type"]:null)};u.backspaceDelete=function(e){return P.isCollapsed()?A(e):R()},e.on("BeforeExecCommand",function(t){var n,r=t.command.toLowerCase();if("indent"==r?S()&&(n=!0):"outdent"==r&&b()&&(n=!0),n)return e.fire("ExecCommand",{command:t.command}),t.preventDefault(),!0}),e.addCommand("InsertUnorderedList",function(e,t){B("UL",t)}),e.addCommand("InsertOrderedList",function(e,t){B("OL",t)}),e.addCommand("InsertDefinitionList",function(e,t){B("DL",t)}),e.addQueryStateHandler("InsertUnorderedList",I("UL")),e.addQueryStateHandler("InsertOrderedList",I("OL")),e.addQueryStateHandler("InsertDefinitionList",I("DL")),e.on("keydown",function(t){9!=t.keyCode||tinymce.util.VK.metaKeyPressed(t)||e.dom.getParent(e.selection.getStart(),"LI,DT,DD")&&(t.preventDefault(),t.shiftKey?b():S())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){for(var n=e.selection.getSelectedBlocks(),r=!1,o=0,a=n.length;!r&&o<a;o++){var d=n[o].nodeName;r="LI"==d&&i(n[o])||"UL"==d||"OL"==d||"DD"==d}t.disabled(r)})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?u.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&u.backspaceDelete(!0)&&e.preventDefault()})});