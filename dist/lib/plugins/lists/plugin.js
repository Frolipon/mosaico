tinymce.PluginManager.add("lists",function(e){function t(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)}function n(e){return e.parentNode.firstChild==e}function r(e){return e.parentNode.lastChild==e}function o(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function a(t){return t===e.getBody()}var i=this;e.on("init",function(){function d(e,t){var n=b.isEmpty(e);return!(t&&b.select("span[data-mce-type=bookmark]").length>0)&&n}function s(e){function t(t){var r,o,a;o=e[t?"startContainer":"endContainer"],a=e[t?"startOffset":"endOffset"],1==o.nodeType&&(r=b.create("span",{"data-mce-type":"bookmark"}),o.hasChildNodes()?(a=Math.min(a,o.childNodes.length-1),t?o.insertBefore(r,o.childNodes[a]):b.insertAfter(r,o.childNodes[a])):o.appendChild(r),o=r,a=0),n[t?"startContainer":"endContainer"]=o,n[t?"startOffset":"endOffset"]=a}var n={};return t(!0),e.collapsed||t(),n}function f(e){function t(t){function n(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}var r,o,a;r=a=e[t?"startContainer":"endContainer"],o=e[t?"startOffset":"endOffset"],r&&(1==r.nodeType&&(o=n(r),r=r.parentNode,b.remove(a)),e[t?"startContainer":"endContainer"]=r,e[t?"startOffset":"endOffset"]=o)}t(!0),t();var n=b.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),D.setRng(n)}function l(t,n){var r,o,a,i=b.createFragment(),d=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(o=b.create(n),o.tagName===e.settings.forced_root_block&&b.setAttribs(o,e.settings.forced_root_block_attrs),i.appendChild(o)),t)for(;r=t.firstChild;){var s=r.nodeName;a||"SPAN"==s&&"bookmark"==r.getAttribute("data-mce-type")||(a=!0),d[s]?(i.appendChild(r),o=null):n?(o||(o=b.create(n),i.appendChild(o)),o.appendChild(r)):i.appendChild(r)}return e.settings.forced_root_block?a||tinymce.Env.ie&&!(tinymce.Env.ie>10)||o.appendChild(b.create("br",{"data-mce-bogus":"1"})):i.appendChild(b.create("br")),i}function c(){return tinymce.grep(D.getSelectedBlocks(),function(e){return/^(LI|DT|DD)$/.test(e.nodeName)})}function m(e,t,n){function r(e){tinymce.each(i,function(n){e.parentNode.insertBefore(n,t.parentNode)}),b.remove(e)}var o,a,i,s;for(i=b.select('span[data-mce-type="bookmark"]',e),n=n||l(t),o=b.createRng(),o.setStartAfter(t),o.setEndAfter(e),a=o.extractContents(),s=a.firstChild;s;s=s.firstChild)if("LI"==s.nodeName&&b.isEmpty(s)){b.remove(s);break}b.isEmpty(a)||b.insertAfter(a,e),b.insertAfter(n,e),d(t.parentNode)&&r(t.parentNode),b.remove(t),d(e)&&b.remove(e)}function p(e){var n,r;if(n=e.nextSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.appendChild(r);b.remove(n)}if(n=e.previousSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.insertBefore(r,e.firstChild);b.remove(n)}}function u(e){tinymce.each(tinymce.grep(b.select("ol,ul",e)),function(e){var n,r=e.parentNode;"LI"==r.nodeName&&r.firstChild==e&&(n=r.previousSibling,n&&"LI"==n.nodeName&&(n.appendChild(e),d(r)&&b.remove(r))),t(r)&&(n=r.previousSibling,n&&"LI"==n.nodeName&&n.appendChild(e))})}function h(e){function o(e){d(e)&&b.remove(e)}var i,s=e.parentNode,f=s.parentNode;return!!a(s)||("DD"==e.nodeName?(b.rename(e,"DT"),!0):n(e)&&r(e)?("LI"==f.nodeName?(b.insertAfter(e,f),o(f),b.remove(s)):t(f)?b.remove(s,!0):(f.insertBefore(l(e),s),b.remove(s)),!0):n(e)?("LI"==f.nodeName?(b.insertAfter(e,f),e.appendChild(s),o(f)):t(f)?f.insertBefore(e,s):(f.insertBefore(l(e),s),b.remove(e)),!0):r(e)?("LI"==f.nodeName?b.insertAfter(e,f):t(f)?b.insertAfter(e,s):(b.insertAfter(l(e),s),b.remove(e)),!0):("LI"==f.nodeName?(s=f,i=l(e,"LI")):i=t(f)?l(e,"LI"):l(e),m(s,e,i),u(s.parentNode),!0))}function C(e){function n(n,r){var o;if(t(n)){for(;o=e.lastChild.firstChild;)r.appendChild(o);b.remove(n)}}var r,o;return"DT"==e.nodeName?(b.rename(e,"DD"),!0):(r=e.previousSibling,r&&t(r)?(r.appendChild(e),!0):r&&"LI"==r.nodeName&&t(r.lastChild)?(r.lastChild.appendChild(e),n(e.lastChild,r.lastChild),!0):(r=e.nextSibling,r&&t(r)?(r.insertBefore(e,r.firstChild),!0):(!r||"LI"!=r.nodeName||!t(e.lastChild))&&(r=e.previousSibling,!(!r||"LI"!=r.nodeName)&&(o=b.create(e.parentNode.nodeName),r.appendChild(o),o.appendChild(e),n(e.lastChild,o),!0))))}function g(){var t=c();if(t.length){for(var n=s(D.getRng(!0)),r=0;r<t.length&&(C(t[r])||0!==r);r++);return f(n),e.nodeChanged(),!0}}function v(){var t=c();if(t.length){var n,r,o=s(D.getRng(!0)),a=e.getBody();for(n=t.length;n--;)for(var i=t[n].parentNode;i&&i!=a;){for(r=t.length;r--;)if(t[r]===i){t.splice(n,1);break}i=i.parentNode}for(n=0;n<t.length&&(h(t[n])||0!==n);n++);return f(o),e.nodeChanged(),!0}}function N(n){function r(){function t(e){var t,n;for(t=i[e?"startContainer":"endContainer"],n=i[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=a;){if(o(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var n,r=[],a=e.getBody(),d=t(!0),s=t(),f=[],l=d;l&&(f.push(l),l!=s);l=l.nextSibling);return tinymce.each(f,function(e){if(o(e))return r.push(e),void(n=null);if(b.isBlock(e)||"BR"==e.nodeName)return"BR"==e.nodeName&&b.remove(e),void(n=null);var t=e.nextSibling;return tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(o(t)||!t&&e.parentNode==a)?void(n=null):(n||(n=b.create("p"),e.parentNode.insertBefore(n,e),r.push(n)),void n.appendChild(e))}),r}var a,i=D.getRng(!0),d="LI";"false"!==b.getContentEditable(D.getNode())&&(n=n.toUpperCase(),"DL"==n&&(d="DT"),a=s(i),tinymce.each(r(),function(e){var r,o;o=e.previousSibling,o&&t(o)&&o.nodeName==n?(r=o,e=b.rename(e,d),o.appendChild(e)):(r=b.create(n),e.parentNode.insertBefore(r,e),r.appendChild(e),e=b.rename(e,d)),p(r)}),f(a))}function y(){var n=s(D.getRng(!0)),r=e.getBody();tinymce.each(c(),function(e){var n,o;if(!a(e.parentNode)){if(d(e))return void h(e);for(n=e;n&&n!=r;n=n.parentNode)t(n)&&(o=n);m(o,e)}}),f(n)}function L(e){var t=b.getParent(D.getStart(),"OL,UL,DL");if(!a(t))if(t)if(t.nodeName==e)y(e);else{var n=s(D.getRng(!0));p(b.rename(t,e)),f(n)}else N(e)}function k(t){return function(){var n=b.getParent(e.selection.getStart(),"UL,OL,DL");return n&&n.nodeName==t}}var b=e.dom,D=e.selection;i.backspaceDelete=function(n){function r(t,n){var r,o,a=t.startContainer,i=t.startOffset;if(3==a.nodeType&&(n?i<a.data.length:i>0))return a;for(r=e.schema.getNonEmptyElements(),o=new tinymce.dom.TreeWalker(t.startContainer);a=o[n?"next":"prev"]();){if("LI"==a.nodeName&&!a.hasChildNodes())return a;if(r[a.nodeName])return a;if(3==a.nodeType&&a.data.length>0)return a}}function o(e,n){var r,o,i=e.parentNode;if(t(n.lastChild)&&(o=n.lastChild),r=n.lastChild,r&&"BR"==r.nodeName&&e.hasChildNodes()&&b.remove(r),d(n,!0)&&b.$(n).empty(),!d(e,!0))for(;r=e.firstChild;)n.appendChild(r);o&&n.appendChild(o),b.remove(e),d(i)&&!a(i)&&b.remove(i)}if(D.isCollapsed()){var i,l,c,m=b.getParent(D.getStart(),"LI");if(m){if(i=m.parentNode,a(i)&&b.isEmpty(i))return!0;if(l=D.getRng(!0),c=b.getParent(r(l,n),"LI"),c&&c!=m){var p=s(l);return n?o(c,m):o(m,c),f(p),!0}if(!c&&!n&&y(i.nodeName))return!0}}},e.on("BeforeExecCommand",function(t){var n,r=t.command.toLowerCase();if("indent"==r?g()&&(n=!0):"outdent"==r&&v()&&(n=!0),n)return e.fire("ExecCommand",{command:t.command}),t.preventDefault(),!0}),e.addCommand("InsertUnorderedList",function(){L("UL")}),e.addCommand("InsertOrderedList",function(){L("OL")}),e.addCommand("InsertDefinitionList",function(){L("DL")}),e.addQueryStateHandler("InsertUnorderedList",k("UL")),e.addQueryStateHandler("InsertOrderedList",k("OL")),e.addQueryStateHandler("InsertDefinitionList",k("DL")),e.on("keydown",function(t){9!=t.keyCode||tinymce.util.VK.metaKeyPressed(t)||e.dom.getParent(e.selection.getStart(),"LI,DT,DD")&&(t.preventDefault(),t.shiftKey?v():g())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){for(var r=e.selection.getSelectedBlocks(),o=!1,a=0,i=r.length;!o&&a<i;a++){var d=r[a].nodeName;o="LI"==d&&n(r[a])||"UL"==d||"OL"==d||"DD"==d}t.disabled(o)})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?i.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&i.backspaceDelete(!0)&&e.preventDefault()})});