tinymce.PluginManager.add("link",function(t){function e(e){return function(){var n=t.settings.link_list;"string"==typeof n?tinymce.util.XHR.send({url:n,success:function(t){e(tinymce.util.JSON.parse(t))}}):"function"==typeof n?n(e):e(n)}}function n(t,e,n){function i(t,n){return n=n||[],tinymce.each(t,function(t){var l={text:t.text||t.title};t.menu?l.menu=i(t.menu):(l.value=t.value,e&&e(l)),n.push(l)}),n}return i(t,n||[])}function i(e){function i(t){var e=u.find("#text");(!e.value()||t.lastControl&&e.value()==t.lastControl.text())&&e.value(t.control.text()),u.find("#href").value(t.control.value())}function l(){!o&&0===k.text.length&&c&&this.parent().parent().find("#text")[0].value(this.value())}function a(e){var n=e.meta||{};d&&d.value(t.convertURL(this.value(),"href")),tinymce.each(e.meta,function(t,e){u.find("#"+e).value(t)}),n.text||l.call(this)}var s,r,o,u,c,f,d,g,x,h,v,m,k={},p=t.selection,y=t.dom;s=p.getNode(),r=y.getParent(s,"a[href]"),c=function(t){var e=p.getContent();if(/</.test(e)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(e)||e.indexOf("href=")==-1))return!1;if(t){var n,i=t.childNodes;if(0===i.length)return!1;for(n=i.length-1;n>=0;n--)if(3!=i[n].nodeType)return!1}return!0}(),k.text=o=r?r.innerText||r.textContent:p.getContent({format:"text"}),k.href=r?y.getAttrib(r,"href"):"",r?k.target=y.getAttrib(r,"target"):t.settings.default_link_target&&(k.target=t.settings.default_link_target),(m=y.getAttrib(r,"rel"))&&(k.rel=m),(m=y.getAttrib(r,"class"))&&(k.class=m),(m=y.getAttrib(r,"title"))&&(k.title=m),c&&(f={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){k.text=this.value()}}),e&&(d={type:"listbox",label:"Link list",values:n(e,function(e){e.value=t.convertURL(e.value||e.url,"href")},[{text:"None",value:""}]),onselect:i,value:t.convertURL(k.href,"href"),onPostRender:function(){d=this}}),t.settings.target_list!==!1&&(t.settings.target_list||(t.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),x={name:"target",type:"listbox",label:"Target",values:n(t.settings.target_list)}),t.settings.rel_list&&(g={name:"rel",type:"listbox",label:"Rel",values:n(t.settings.rel_list)}),t.settings.link_class_list&&(h={name:"class",type:"listbox",label:"Class",values:n(t.settings.link_class_list,function(e){e.value&&(e.textStyle=function(){return t.formatter.getCssText({inline:"a",classes:[e.value]})})})}),t.settings.link_title!==!1&&(v={name:"title",type:"textbox",label:"Title",value:k.title}),u=t.windowManager.open({title:"Insert link",data:k,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:a,onkeyup:l},f,v,function(e){var n=[];if(tinymce.each(t.dom.select("a:not([href])"),function(t){var i=t.name||t.id;i&&n.push({text:i,value:"#"+i,selected:e.indexOf("#"+i)!=-1})}),n.length)return n.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:n,onselect:i}}(k.href),d,g,x,h],onSubmit:function(e){function n(e,n){var i=t.selection.getRng();tinymce.util.Delay.setEditorTimeout(t,function(){t.windowManager.confirm(e,function(e){t.selection.setRng(i),n(e)})})}function i(){var e={href:l,target:k.target?k.target:null,rel:k.rel?k.rel:null,class:k.class?k.class:null,title:k.title?k.title:null};r?(t.focus(),c&&k.text!=o&&("innerText"in r?r.innerText=k.text:r.textContent=k.text),y.setAttribs(r,e),p.select(r),t.undoManager.add()):c?t.insertContent(y.createHTML("a",e,y.encode(k.text))):t.execCommand("mceInsertLink",!1,e)}var l;return k=tinymce.extend(k,e.data),(l=k.href)?l.indexOf("@")>0&&l.indexOf("//")==-1&&l.indexOf("mailto:")==-1?void n("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(t){t&&(l="mailto:"+l),i()}):t.settings.link_assume_external_targets&&!/^\w+:/i.test(l)||!t.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(l)?void n("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(t){t&&(l="http://"+l),i()}):void i():void t.execCommand("unlink")}})}t.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:e(i),stateSelector:"a[href]"}),t.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),t.addShortcut("Meta+K","",e(i)),t.addCommand("mceLink",e(i)),this.showDialog=i,t.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:e(i),stateSelector:"a[href]",context:"insert",prependToContext:!0})});